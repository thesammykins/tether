name: Enforce linked issue

on:
  pull_request_target:
    types: [opened, edited, reopened]

permissions:
  pull-requests: write
  issues: read

jobs:
  check-linked-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Check for linked issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;

            // 1. Check via GraphQL closingIssuesReferences (the authoritative source)
            const result = await github.graphql(`
              query($owner: String!, $repo: String!, $pr: Int!) {
                repository(owner: $owner, name: $repo) {
                  pullRequest(number: $pr) {
                    closingIssuesReferences(first: 1) {
                      totalCount
                    }
                  }
                }
              }
            `, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              pr: pr.number
            });

            const linkedCount = result.repository.pullRequest.closingIssuesReferences.totalCount;
            if (linkedCount > 0) {
              core.info(`PR #${pr.number} has a linked issue. All good.`);
              return;
            }

            // No linked issue found â€” close the PR
            const repoUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}`;
            const docsUrl = `${repoUrl}/blob/${context.payload.repository.default_branch}/CONTRIBUTING.md`;
            const message = [
              '**This PR has been automatically closed.**',
              '',
              'Every PR must reference an existing issue using a',
              '[closing keyword](https://docs.github.com/en/issues/tracking-your-work-with-issues/using-issues/linking-a-pull-request-to-an-issue)',
              '(e.g., `Closes #123`, `Fixes #42`).',
              '',
              'Please:',
              '1. Open an issue describing the change (if one doesn\'t exist)',
              '2. Re-open this PR with the issue linked in the description',
              '',
              `See [CONTRIBUTING.md](${docsUrl}) for full requirements.`
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: message
            });

            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              state: 'closed'
            });

            core.setFailed(`PR #${pr.number} closed: no linked issue found.`);
